@page
@{
    ViewData["Title"] = "Form Designer";
}
<h2>Form Designer</h2>
<div id="formDesignerToolbar" style="margin-bottom:10px;">
  <input id="formName" type="text" placeholder="Form Name" style="width:250px;" />
  <button id="saveFormBtn" class="btn btn-primary">Save Form</button>
  <select id="loadFormSelect"></select>
  <button id="loadFormBtn" class="btn btn-secondary">Load</button>
</div>
<div id="surveyCreatorContainer" style="height:800px;"></div>

<script src="https://unpkg.com/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://unpkg.com/survey-core@1.9.131/survey.core.min.js"></script>
<link href="https://unpkg.com/survey-core@1.9.131/defaultV2.min.css" rel="stylesheet" />
<script src="https://unpkg.com/survey-creator-core@1.9.131/survey-creator-core.min.js"></script>
<script src="https://unpkg.com/survey-creator-knockout@1.9.131/survey-creator-knockout.min.js"></script>
<link href="https://unpkg.com/survey-creator-core@1.9.131/survey-creator-core.min.css" rel="stylesheet" />

<script>
  // Basic creator init
  const options = { showLogicTab: true, showJSONEditorTab: true, showTestSurveyTab: true };
  const creator = new SurveyCreator.SurveyCreator(options);
  creator.render('surveyCreatorContainer');

  async function loadDefinitions() {
    const defs = await fetch('/api/forms/definitions').then(r => r.json());
    const select = $('#loadFormSelect');
    select.empty();
    select.append(`<option value="">--Select Form--</option>`);
    defs.forEach(d => select.append(`<option value="${d.formDefinitionId}">${d.name} (v${d.version})</option>`));
  }

  $('#saveFormBtn').on('click', async () => {
    const name = $('#formName').val() || 'Untitled Form';
    const payload = { name: name, json: creator.JSON, isActive: true };
    const res = await fetch('/api/forms/definitions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if (res.ok) { alert('Saved!'); loadDefinitions(); } else { alert('Save failed'); }
  });

  $('#loadFormBtn').on('click', async () => {
    const id = $('#loadFormSelect').val();
    if (!id) return;
    const def = await fetch(`/api/forms/definitions/${id}`).then(r=>r.json());
    creator.text = def.json; // load JSON text
    $('#formName').val(def.name);
  });

  loadDefinitions();
</script>
